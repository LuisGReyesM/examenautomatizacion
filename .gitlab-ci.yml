stages:
  - sync
  - build
  - test

# ==========================================================
#                      STAGE SYNC
# ==========================================================
sync-github-repo:
  stage: sync
  image: alpine/git:latest
  script:
    # Configuraci√≥n de git
    - git config --global user.name "GitLab CI"
    - git config --global user.email "ci@example.com"

    # Clonar si no existe, si existe hacer fetch
    - |
      if [ ! -d ".git" ]; then
        git clone https://github.com/LuisGReyesM/examenautomatizacion.git .
      else
        git remote set-url origin https://github.com/LuisGReyesM/examenautomatizacion.git
        git fetch origin
      fi

    # Sincronizar main
    - git checkout main
    - git reset --hard origin/main

    # ==========================================================
    # Actualizar GitLab usando token directo
    # ==========================================================
    - git remote add gitlab https://USERNAME:${GITLAB_TOKEN}@gitlab.com/LuisGReyesM/examenautomatizacion.git
    - git push gitlab main --force

  only:
    - main

# ==========================================================
#                      STAGE BUILD
# ==========================================================
build-job:
  stage: build
  image: openjdk:11-jre-slim
  script:
    - ./mvnw compile
  needs:
    - sync-github-repo

# ==========================================================
#                       STAGE TEST
# ==========================================================
unit-test-job:
  stage: test
  image: openjdk:11-jre-slim
  script:
    - ./mvnw test
  needs:
    - build-job

integration-test-job:
  stage: test
  image: openjdk:11-jre-slim
  script:
    - ./mvnw verify
  needs:
    - build-job
